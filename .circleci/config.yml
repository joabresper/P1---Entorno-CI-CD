version: 2.1

node_image: &node_image cimg/node:22.12.0

orbs:
  discord: antonioned/discord@0.1.0
  sonarcloud: sonarsource/sonarcloud@3.0

jobs:
  create-environment:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run: node --version
      - run:
          name: Install dependencies
          command: npm install
      - discord/status:
          fail_only: true
          webhook: "${DISCORD_WEBHOOK}"
          failure_message: "**❌ Falló la creación del entorno.** Revisá los pasos de instalación.\\n\\nUsuario: **${CIRCLE_USERNAME}**"

  run-tests:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run tests
          command: npm test
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Pruebas completadas con éxito!** Todo salió bien!\\n\\nUsuario: **${CIRCLE_USERNAME}**"
          failure_message: "**❌ Las pruebas fallaron.** Revisá los resultados.\\n\\nUsuario: **${CIRCLE_USERNAME}**"
  
  move-trello-card-to-done:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: Move card to trello done list
          command: |
            COMMIT_MSG=$(git log -1 --pretty=%B)

            CARD_ID=$(curl -s "https://api.trello.com/1/boards/${TRELLO_BOARD_ID}/cards/all?key=${TRELLO_API_KEY}&token=${TRELLO_SECRET_TOKEN}" \
              | jq -r --arg msg "${COMMIT_MSG}" '.[] | select(.name | contains($msg)) | .id' \
              | head -n 1)

            curl -s -X PUT "https://api.trello.com/1/cards/${CARD_ID}?idList=${TRELLO_DONE_LIST_ID}&key=${TRELLO_API_KEY}&token=${TRELLO_SECRET_TOKEN}"
      # - discord/status:
      #     webhook: "${DISCORD_TRELLO_WEBHOOK}"
      #     failure_message: "Targeta \"**$(COMMIT_MSG)**\" no entontrada. No se pudo mover a Hecho en el tablero."

  move-trello-card:
    docker:
      - image: cimg/base:stable
    parameters:
      trello_list:
        type: string
      message:
        type: string
        default: "el pipeline"
    steps:
      - checkout
      - run:
          name: Move card to trello errors list 
          command: |
            COMMIT_MSG=$(git log -1 --pretty=%B)
            CARD_SHORT_ID=$(echo "$COMMIT_MSG" | sed -n 's/.*\[\([^]]*\)\].*/\1/p')
            AUTHOR=$(git log -1 --pretty='%an')
            curl -s -X PUT "https://api.trello.com/1/cards/${CARD_SHORT_ID}?idList=${<< parameters.trello_list >>}&key=${TRELLO_API_KEY}&token=${TRELLO_SECRET_TOKEN}"
            
            if [ << parameters.trello_list >> == "TRELLO_ERRORS_LIST_ID" ]; then
              TEXT="CircleCI detectó un error en << parameters.message >> | GitHubUser: ${AUTHOR}"
              ENCODED_TEXT=$(printf "%s" "${TEXT}" | jq -sRr @uri)

              curl --request POST \
                --url "https://api.trello.com/1/cards/${CARD_SHORT_ID}/actions/comments?text=${ENCODED_TEXT}&key=${TRELLO_API_KEY}&token=${TRELLO_SECRET_TOKEN}" \
                --header 'Accept: application/json'
            fi

  deploy:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Deploy in Render
          command: |
            curl -X POST "$RENDER_DEPLOY_HOOK_URL"
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Se inicio correctamente el deploy!**"
          failure_message: "**❌ Fallo en la inicializacion del deploy.**"
  
  check-deploy-status:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Check deploy status
          command: |
            for i in {1..10}; do
              if curl -sSf ${RENDER_APP_URL} > /dev/null; then
                echo "Sitio activo"
                break
              fi
              echo "Esperando que el sitio esté disponible..."
              sleep 5
            done

  check-deploy-status2:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Check deploy status
          command: |
              sleep 60
  
  bombardier-test-pass:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Install Bombardier
          command: |
            curl -L https://github.com/codesenberg/bombardier/releases/download/v1.2.5/bombardier-linux-amd64 -o bombardier
            chmod +x bombardier
            sudo mv bombardier /usr/local/bin/
            echo "Bombardier installed successfully"
      - run:
          name: Run concurrency test with Bombardier
          command: |
            bombardier -c 100 -n 10 ${RENDER_APP_URL} > output.txt
            cat output.txt
            if grep -qE "4xx - [1-9]|5xx - [1-9]" output.txt; then
              exit 1
            fi
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Prueba de carga pesada completada con éxito!**\\nNo hubo errores HTTP!"
          failure_message: "**❌ La prueba de carga pesada falló.**\\nHubo errores HTTP. Revisá los resultados."
  
  bombardier-test-fail:
    docker:
      - image: cimg/base:stable
    steps:
      - run:
          name: Install Bombardier
          command: |
            curl -L https://github.com/codesenberg/bombardier/releases/download/v1.2.5/bombardier-linux-amd64 -o bombardier
            chmod +x bombardier
            sudo mv bombardier /usr/local/bin/
            echo "Bombardier installed successfully"
      - run:
          name: Run concurrency test with Bombardier
          command: |
            bombardier -c 500 -n 10000 ${RENDER_APP_URL} > output.txt
            cat output.txt
            if grep -qE "4xx - [1-9]|5xx - [1-9]" output.txt; then
              exit 1
            fi
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Prueba de carga pesada completada con éxito!**\\nNo hubo errores HTTP!"
          failure_message: "**❌ La prueba de carga pesada falló.**\\nHubo errores HTTP. Revisá los resultados."
  
  sonarcloud:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - sonarcloud/scan
      - run:
          name: Check SonarCloud Quality Gate status
          command: |
            response=$(curl -s -u ${SONAR_TOKEN}: "https://sonarcloud.io/api/qualitygates/project_status?projectKey=${SONAR_PROJECT_KEY}")
            status=$(echo $response | jq -r '.projectStatus.status')
            echo "Quality Gate status: $status"
            echo "export QUALITY_GATE_STATUS=$status" > status.env

            if [ "$status" != "OK" ]; then
              echo "Quality Gate failed!"
              exit 1
            fi
      - run:
          name: Load Quality Gate status
          command: |
            source status.env
            echo "Status loaded: $QUALITY_GATE_STATUS"
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ SonarCloud análisis completado con éxito!**\\nLa calidad del código es buena!"
          failure_message: "**❌ SonarCloud análisis falló.**\\nRevisá los resultados de la calidad del código." 

workflows:
  full:
    jobs:
      - create-environment
      - run-tests:
          requires:
            - create-environment
      - move-trello-card:
          trello_list: "TRELLO_ERRORS_LIST_ID"
          message: "Pruebas"
          requires:
            - run-tests:
              - failed
      - sonarcloud:
          requires:
            - run-tests
      - move-trello-card:
          trello_list: "TRELLO_ERRORS_LIST_ID"
          requires:
            - sonarcloud:
              - failed
      - deploy:
          requires:
            - sonarcloud
      - move-trello-card:
          trello_list: "TRELLO_DONE_LIST_ID"
          requires:
            - sonarcloud
      - check-deploy-status2:
          requires:
            - deploy
      - bombardier-test-fail:
          requires:
            - check-deploy-status2 
  # bombardier-pass:
  #   jobs:
  #     - bombardier-test-pass

  # bombardier-fail:
  #   jobs:
  #     - bombardier-test-fail
  # sonarcloud:
  #   jobs:
  #     - sonarcloud
    # filters:
    #   branches:
    #     only:
    #       - develop
