version: 2.1

orbs:
  discord: antonioned/discord@0.1.0

jobs:
  create-environment:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run: node --version
      - run:
          name: Install dependencies
          command: npm install
      - discord/status:
          fail_only: true
          webhook: "${DISCORD_WEBHOOK}"
          failure_message: "**❌ Falló la creación del entorno.** Revisá los pasos de instalación.\\n\\nUsuario: **${CIRCLE_USERNAME}**"

  run-tests:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Run tests
          command: npm test
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Pruebas completadas con éxito!** Todo salió bien!\\n\\nUsuario: **${CIRCLE_USERNAME}**"
          failure_message: "**❌ Las pruebas fallaron.** Revisá los resultados.\\n\\nUsuario: **${CIRCLE_USERNAME}**"
  
  done-trello-card:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Move to done trello card
          command: |
            COMMIT_MSG=$(git log -1 --pretty=%B)

            asd=$(curl -s 'https://api.trello.com/1/boards/rSRh5VAY/cards/all?key=720ab680f0e650579d81bec987f5fcf3&token=ATTAf77cf189fa0417c0de18ee83ce8f16799d61b9357f36de257be4eccc155c0dddFA1F7BE1')
            echo "$asd"
            echo "CARD_ID: $CARD_ID"

deploy:
    docker:
      - image: cimg/node:22.12.0
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: npm install
      - run:
          name: Deploy in Render
          command: |
            curl -X POST "$RENDER_DEPLOY_HOOK_URL"
      - discord/status:
          webhook: "${DISCORD_WEBHOOK}"
          success_message: "**✅ Se inicio correctamente el deploy!**"
          failure_message: "**❌ Fallo en la inicializacion del deploy.**"

workflows:
  my-test:
    jobs:
      # - create-environment
      # - run-tests:
      #     requires:
      #       - create-environment
      # - deploy:
      #     requires:
      #       - run-tests
      - done-trello-card
          # requires:
          #   - run-tests